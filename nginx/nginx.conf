worker_processes auto;

events { worker_connections 1024; }

http {
  include mime.types;
  default_type application/octet-stream;
  sendfile on;
  keepalive_timeout 65;
  client_max_body_size 100M;

  # compresión gzip, limitación de peticiones y caché simple de proxy
  gzip on;
  gzip_types text/plain application/json application/javascript text/css application/xml;
  gzip_proxied any;
  gzip_min_length 256;

  # Límite de peticiones: 5 solicitudes por segundo por IP
  limit_req_zone $binary_remote_addr zone=one:10m rate=5r/s;

  # Caché simple de proxy para recursos mayormente estáticos (por ejemplo, listado de productos)
  proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=my_cache:10m max_size=100m inactive=10m use_temp_path=off;

  upstream products  { server products_service:3001; }
  upstream customers { server customers_service:3002; }
  upstream orders    { server orders_service:3003; }
  proxy_set_header Host              $host;
  proxy_set_header X-Real-IP         $remote_addr;
  proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_http_version 1.1;
  proxy_set_header Connection "";
  proxy_read_timeout 60s;
  proxy_send_timeout 60s;

  server {
    listen 80;
    server_name _;

  # Aplicar limitación de peticiones (sin bursts)
  limit_req zone=one;

    # PRODUCTOS
    location /products {
      # cachear respuestas de productos por un periodo corto para reducir carga en el backend
      proxy_cache my_cache;
      proxy_cache_valid 200 60s;
      proxy_cache_key $scheme$proxy_host$request_uri;
      add_header X-Cache-Status $upstream_cache_status;
      proxy_pass http://products;
    }

    # CLIENTES
    location /customers { proxy_pass http://customers; }

    # PEDIDOS
    location /orders { proxy_pass http://orders; }

    location = /healthz { 
      return 200 'ok'; 
      add_header Content-Type text/plain; 
    }
    
    location / { return 404; }
  }
}